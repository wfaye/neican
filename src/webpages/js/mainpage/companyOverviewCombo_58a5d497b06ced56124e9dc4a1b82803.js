registerNS("iv.follow.manager");iv.follow.manager={processItems:function(list){var $this=this;_.each(list,function(item){$this.createFollowWidgetItem(item.selector,item.config);});},createWidgets:function(list){this.processItems(list);iv.initMenus();},createFollowWidgetItem:function(selector,config){$(selector).setupFollow(config);
}};(function($){var ivFollow=function(elem,options){this.followContainer=elem;this.clickedElem=null;this.isActionActive=false;this.uid=options.uid;this.followId=options.followId;this.config={entityType:"company",followType:"inline",trackedByWatchlists:[],urls:{"follow":"/iv/followEntityInWatchlist.iv","unfollow":"/iv/unfollowEntityFromWatchlist.iv"},menuHeaderTemplate:'<div id="add_<~%=current%~>"> <ul class="menu follow-menu '+"<~% if(trackedByWatchlists.length != 0) { %~>"+"following-type-<~%=followType%~> "+"<~% } else { %~>"+"follow-type-<~%=followType%~> "+"<~% } %~>"+' ieOverride" id="wlAddMenu_<~%=uid%~>">'+"<li>"+"<~% if(trackedByWatchlists.length != 0) { %~>"+'<a class="<~% if(followType == "inline"){%~> hover-button<~% } %~>" href="javascript:void(0);">'+'<div title="Add <~%=entityType%~> to your InsideView Watchlist" class="following-<~%=followType%~>-<~%=entityType%~>">'+'<div class="new-follow-sprite followingSymbol"></div>'+'<span class="textHook float_left">Following</span>'+'<span class="new-follow-sprite track-arw-<~%=followType%~>"></span> '+"<~% } else { %~>"+' <a class="<~% if(followType == "inline"){%~> hover-button<~% } %~>" href="javascript:void(0);">'+'<div title="Add <~%=entityType%~> to your InsideView Watchlist" class="follow-<~%=followType%~>-<~%=entityType%~>">'+'<div class="new-follow-sprite followSymbol"></div>'+'<span class="textHook float_left">Follow</span> '+'<span class="new-follow-sprite float_left track-arw-<~%=followType%~>"></span> '+"<~% } %~>"+"</div>"+'<div style="clear: both; height: 0px; width: 0px;"></div></a>',menuBodyTemplate:"<ul>"+"<~%_.each(watchlistInfo , function(wlObj){%~>"+'<li style="clear:both;">'+'<~% if(wlObj["type"] == 2) { %~>'+'<~% if($.inArray(wlObj["id"],trackedByWatchlists) > -1 || $.inArray(wlObj["id"],trackedByWatchlists) != -1) { %~>'+'<a class="following-<~%=entityType%~>-freq following-entity freq-viewed-wl" id="<~%=wlObj["id"]%~>" rel="<~%=wlObj["id"]%~>"><img src="/iv/common/styles/images/checked2.png" height="16" width="16" align="absmiddle" style="visibility:visible"/>&nbsp;'+'<span><~%=wlObj["name"]%~></span></a>'+"<~%}else{%~>"+'<span class="dynamic follow" title="Frequently Viewed Watchlist - cannot add '+" <~% entityType == \"company\" ? 'companies' : 'people'; %~>"+' manually."><img width="16" height="16" align="absmiddle" style="visibility:hidden;padding-right:5px;" src="/iv/common/styles/images/checked2.png">Frequently Viewed</span>'+"<~%}%~>"+'<~%}else if(wlObj["type"] == 0){%~>'+'<~% if($.inArray(wlObj["id"],trackedByWatchlists) > -1 || $.inArray(wlObj["id"],trackedByWatchlists) != -1) { %~>'+'<a rel="<~%=wlObj["id"]%~>" href="javascript:void(0);" class="following-entity">'+'<img src="/iv/common/styles/images/checked2.png" height="16" width="16" align="absmiddle"/>&nbsp;'+"<~%}else{%~>"+'<a rel="<~%=wlObj["id"]%~>" href="javascript:void(0);" class="follow-entity">'+'<img src="/iv/common/styles/images/checked2.png" height="16" width="16" align="absmiddle" style="visibility:hidden"/>&nbsp;'+"<~%}%~>"+'<~% if(wlObj["name"].length > 17){ wlObj["name"] = wlObj["name"].substring(0,14) + "..."; %~>'+"<~%}%~>"+'<span><~%=wlObj["name"]%~></span></a>'+'<~%}else if(wlObj["type"] == 1){%~>'+'<span class="dynamic follow" title="Automated Watchlist - cannot add '+"<~% entityType == \"company\" ? 'companies' : 'people'; %~> manually.\">"+'<img src="/iv/common/styles/images/checked2.png" height="16" width="16" align="absmiddle" '+'<~% if($.inArray(wlObj["id"],trackedByWatchlists) == -1) { %~>'+'style="visibility:hidden"'+"<~%}%~>  />&nbsp;"+'<img align="absmiddle" src="/iv/common/styles/images/salesforce_logo.png" style="width:16px;height:16px;padding-right:5px;"/>'+'<~% if(wlObj["name"].length > 17){ wlObj["name"] = wlObj["name"].substring(0,14) + "..."; %~>'+"<~%}%~>"+'<~%=wlObj["name"]%~></span></li>'+"<~%}});%~>"+"<~% if(dynamicCreateWL != false) { %~>"+'<li class="createAutomatedWL">'+'<~% if(dynamicCreateWL == "enabled") { %~>'+'<a href="/iv/watchlist.iv?dynamicWatchlistEnabled=true&newSFDCWatchList=true" target="insideview">'+"<span>Create Automated Watchlist</span></a>"+"<~%} else {%~>"+'<span class="dynamic">Create Automated Watchlist</span>'+"<~%}%~>"+"</li>"+"<~%}%~>"+"</ul></li></ul></div>"};
if(typeof options!="undefined"){$.extend(true,this.config,options);}if(this.config.entityType=="company"){this.entityParams={type:"company",companyId:this.config.companyId};this.config.currentId=this.config.companyId;}else{if(this.config.entityType=="person"){this.entityParams={type:"person",employmentId:this.config.employmentId,executiveId:this.config.executiveId};
this.config.currentId=this.config.executiveId;}}this.showFollowMenu();this.attachDelegates();};ivFollow.prototype.showFollowMenu=function(){var html="";var d=new Date();var dynamicCreateWL=false;if(iv.user.data.dynamicWLEnabled!="false"&&iv.isMashup){if(_.size(iv.user.data.genericWatchlistInfo)<iv.user.data.maxWLSize){dynamicCreateWL="enabled";
}else{dynamicCreateWL="disabled";}}var trackedByWatchlists=[];_.each(this.config.trackedByWatchlists,function(watchlistId){if(watchlistId!=""){trackedByWatchlists.push(parseInt(watchlistId));}});this.config.trackedByWatchlists=trackedByWatchlists;html+=_.template(this.config.menuHeaderTemplate,{trackedByWatchlists:this.config.trackedByWatchlists,followType:this.config.followType,current:this.config.currentId,entityType:this.config.entityType,uid:this.uid});
var html2=_.template(this.config.menuBodyTemplate,{trackedByWatchlists:this.config.trackedByWatchlists,watchlistInfo:this.config.watchlistInfo,followType:this.config.followType,current:this.config.currentId,entityType:this.config.entityType,dynamicCreateWL:dynamicCreateWL});this.followContainer.html(html+html2);
};ivFollow.prototype.attachDelegates=function(){var $this=this;if($("body").hasClass("follow-entity-init")){return;}$("body").delegate("a","click",function(){var target=$(this);if(!target.hasClass("follow-entity")&&!target.hasClass("following-entity")){return;}var targEntity=iv.user.followMetaData[target.parents(".follow-menu").attr("id").split("_")[1]];
if(target.hasClass("follow-entity")&&!targEntity.isActionActive){targEntity.isActionActive=true;target.css("opacity","0.5");var wId=target.attr("rel");targEntity.clickedElem=target.find("span");target.removeClass("follow-entity").addClass("following-entity");$.extend(targEntity.entityParams,{watchlistId:wId});
targEntity.followAction("follow");}else{if(target.hasClass("following-entity")&&!targEntity.isActionActive){targEntity.isActionActive=true;target.css("opacity","0.5");var wId=target.attr("rel");targEntity.clickedElem=target.find("span");$.extend(targEntity.entityParams,{watchlistId:wId});if(target.hasClass("following-"+targEntity.config.entityType+"-freq")){target.removeClass("following-"+$this.config.entityType+"-freq").css("opacity","0.5");
target.css("cursor","normal");target.removeClass("following-entity");}else{target.removeClass("following-entity").addClass("follow-entity");}targEntity.followAction("unfollow");}}});$("body").addClass("follow-entity-init");};ivFollow.prototype.actionCallback=function(resp){this.isActionActive=false;if(resp.error==false){iv.hub.publishEvent("REFRESH_SETUP","followCompanies");
var menuId="wlAddMenu_"+this.uid;var spanText=$("#"+menuId).find(".textHook");if($(this.clickedElem).parent("a").find("img").css("visibility")=="hidden"){$(this.clickedElem).parent("a").find("img").css("visibility","visible");$(this.clickedElem).parent("a").css("opacity","1");this.config.trackedByWatchlists.splice(0,0,this.entityParams.watchlistId);
var watchlistId=$(this.clickedElem).parent("a").attr("rel");if(this.config.entityType=="company"){iv.user.data.genericWatchlistInfo[watchlistId]["companies"].push(this.followId);}else{iv.user.data.genericWatchlistInfo[watchlistId]["executives"].push(this.followId);}if(spanText.text()=="Follow"){$("#"+menuId).removeClass("follow-type-"+this.config.followType).addClass("following-type-"+this.config.followType);
spanText.text("Following");$("#"+menuId).find("div.new-follow-sprite").removeClass("followSymbol").addClass("followingSymbol");spanText.parent("div").removeClass("follow-"+this.config.followType+"-"+this.config.entityType).addClass("following-"+this.config.followType+"-"+this.config.entityType);}}else{$(this.clickedElem).parent("a").find("img").css("visibility","hidden");
if($(this.clickedElem).parent("a").hasClass("freq-viewed-wl")){$(this.clickedElem).parent("a").css("opacity","0.5");}else{$(this.clickedElem).parent("a").css("opacity","1");}var index=$.inArray(this.entityParams.watchlistId,this.config.trackedByWatchlists);this.config.trackedByWatchlists.splice(index,1);
var watchlistId=$(this.clickedElem).parent("a").attr("rel");if(this.config.entityType=="company"){iv.user.data.genericWatchlistInfo[watchlistId]["companies"]=_.without(iv.user.data.genericWatchlistInfo[watchlistId]["companies"],this.followId);}else{iv.user.data.genericWatchlistInfo[watchlistId]["executives"]=_.without(iv.user.data.genericWatchlistInfo[watchlistId]["executives"],this.followId);
}if(spanText.text()=="Following"&&this.config.trackedByWatchlists.length==0){$("#"+menuId).removeClass("following-type-"+this.config.followType).addClass("follow-type-"+this.config.followType);spanText.text("Follow");$("#"+menuId).find("div.new-follow-sprite").removeClass("followingSymbol").addClass("followSymbol");
spanText.parent("div").removeClass("following-"+this.config.followType+"-"+this.config.entityType).addClass("follow-"+this.config.followType+"-"+this.config.entityType);}}}else{if(resp.error==true){this.isActionActive=false;if($(this.clickedElem).parent("a").hasClass("following-entity")){$(this.clickedElem).parent("a").removeClass("following-entity").addClass("follow-entity");
}else{$(this.clickedElem).parent("a").removeClass("follow-entity").addClass("following-entity");}$(this.clickedElem).parent("a").css("opacity","1");if(resp.errorType="WatchlistLimitError"){iv.stopPoint.show("addRecordsToWatchlist");}}}};ivFollow.prototype.followAction=function(followtype){var $this=this;
iv.api.userAction.getJson({resource:this.config.urls[followtype],urlParams:this.entityParams,success:function(resp){$this.actionCallback(resp);},error:function(resp){$this.actionCallback(resp);}});};$.fn.setupFollow=function(options){var ts=iv.util.getUniqueId();if(typeof options.companyId!=="undefined"){var uid=options.companyId+ts;
var followId=options.companyId;}else{var uid=options.executiveId+options.employmentId+ts;var followId=options.executiveId;}options["uid"]=uid;options["followId"]=followId;registerNS("iv.user.followMetaData");iv.user.followMetaData[uid]=new ivFollow(this,options);return iv.user.followMetaData[uid];};})(jQuery);
function shareObject(param){this.id=param.newsId;this.cuid=param.newsId+param.companyId+param.agentId;this.uniqueId=param.newsId+"|"+param.companyId+"|"+param.agentId;this.newsId=param.newsId;this.companyId=param.companyId;this.companyName=param.companyName;this.newsTitle=param.newsTitle;this.agentName=param.agentName;
this.agentId=param.agentId;this.crmAccountId=param.crmAccountId;this.crmObjectId=param.crmObjectId;this.crmOpportunityId=param.crmOpportunityId;this.crmContext=param.crmContext;this.showChatter=param.showChatter;this.showSaveAs=param.showSaveAs;this.showActivity=param.showDynamicsActivityFeed;this.urls=null;
this.hasMarkUp=false;this.menu="";}shareObject.prototype.createUrls=function(){var articleUrl=document.location.protocol+"//"+document.location.host+"/iv/launchReferredArticle.do?aid="+encodeURIComponent(this.newsId)+"&cid="+encodeURIComponent(this.companyId)+"&st="+encodeURIComponent(this.agentName);
var facebookUrl="http://www.facebook.com/sharer.php"+"?u="+encodeURIComponent(articleUrl)+"&t="+encodeURIComponent(encodeSingleQuotes(this.newsTitle));var linkedinUrl="http://www.linkedin.com/shareArticle?mini=true"+"&url="+encodeURIComponent(articleUrl)+"&title="+encodeURIComponent(encodeSingleQuotes(this.newsTitle))+"&source="+encodeURIComponent("http://www.insideview.com");
var twitterUrl="http://wd.sharethis.com/api/sharer.php?destination=twitter"+"&url="+encodeURIComponent(articleUrl)+"&title="+encodeURIComponent(encodeSingleQuotes(this.newsTitle))+"%20-%20via%20@InsideView";var saveAsUrl="/iv/export.do?exportType=saveArticle"+"&company_name="+encodeURIComponent(encodeSingleQuotes(this.companyName))+"&article_url="+encodeURIComponent(articleUrl)+"&article_title="+encodeURIComponent(encodeSingleQuotes(this.newsTitle))+"&crm_context="+encodeURIComponent(this.crmContext)+"&crm_account_id="+encodeURIComponent(this.crmAccountId)+"&crm_object_id="+encodeURIComponent(this.crmObjectId)+"&crm_opportunity_id="+encodeURIComponent(this.crmOpportunityId);
var emailUrl="/iv/launchArticle.do?"+"&article_id="+this.newsId+"&company_id="+this.companyId+"&mode=SellingTrigger"+"&emailArticle=true"+"&company_name="+encodeURIComponent(encodeSingleQuotes(this.companyName))+"&article_title="+encodeURIComponent(encodeSingleQuotes(this.newsTitle))+"&selling_trigger="+encodeURIComponent(this.agentName);
this.urls={};this.urls.articleUrl=articleUrl;this.urls.facebookUrl=facebookUrl;this.urls.linkedinUrl=linkedinUrl;this.urls.twitterUrl=twitterUrl;this.urls.emailUrl=emailUrl;this.urls.saveAsUrl=saveAsUrl;};shareObject.prototype.show=function(target){if(!this.hasMarkUp){this.createUrls();this.menu=this.createShareMenu();
this.hasMarkUp=true;}target.innerHTML=this.menu;var ref=this;if(this.showChatter){$("#share_chatter"+ref.cuid).bind("click",function(event){share.chatter.showChatter(ref.urls.articleUrl,ref.newsTitle,ref.crmAccountId,ref.crmObjectId,ref.crmOpportunityId,ref.crmContext);event.stopPropagation();return false;
});}share.activity.initShareMenuForActivity(ref);};shareObject.prototype.getMenuItem=function(params){return _.template(iv.ui.getTemplate("shareMenuItem"),params);};shareObject.prototype.createShareMenu=function(){var html="";html+=this.getMenuItem({"type":"email","title":"Email","image":"share_email.png","url":encodeSingleQuotes(this.urls.emailUrl),"id":"email"+this.uniqueId});
html+=this.getMenuItem({"type":"facebook","title":"Facebook","image":"icn_facebook.gif","url":encodeSingleQuotes(this.urls.facebookUrl),"id":"fb"+this.uniqueId});html+=this.getMenuItem({"type":"twitter","title":"Twitter","image":"icn_twitter.png","url":encodeURIComponent(encodeSingleQuotes(this.urls.twitterUrl)),"id":"twit"+this.uniqueId});
html+=this.getMenuItem({"type":"linkedin","title":"LinkedIn","image":"icn_linkedin.gif","url":encodeURIComponent(encodeSingleQuotes(this.urls.linkedinUrl)),"id":"linkedin"+this.uniqueId});if(this.showChatter){html+=this.getMenuItem({"type":"chatter","title":"Chatter","image":"icn_chatter.png","url":"","id":"share_chatter"+this.cuid});
}if(this.showActivity){html+=this.getMenuItem({"type":"activity","title":"Activity","image":"icn_activity.png","url":"","id":"sa"+this.cuid});}if(this.showSaveAs){html+=this.getMenuItem({"type":"saveas","title":"Save as...","image":"icn_chatter.png","url":encodeSingleQuotes(this.urls.saveAsUrl),"id":""});
}return html;};var share={id:"",chatterHtml:"",activityHtml:"",first:true,shareObjects:{},modal:null,curChatter:{},curActivity:{},container:null,isDisplayed:false,inMashup:false,hook:""};share.runInMashup=function(hooker){this.inMashup=true;this.hook=hooker;};share.init=function(){this.container=document.createElement("div");
this.container.id="share-menu-cont";this.container.className="share-menu-cont";var targ=$(document.body);if(this.inMashup){targ=$("#"+this.hook);iv.hub.subscribeToEvent("DEFAULT_PAGE_SCROLL",share.hideShareMenu,this);}targ.append($(this.container));$(document.body).click(function(event){if($(event.target).parents(".share-link").length==0){share.hideShareMenu();
}});$("body").delegate(".share-link","click",function(event){var elem=$(this);share.launchShareMenu(elem.attr("id"));event.stopPropagation();return false;});};share.initShareMenuForArticleLaunch=function(share_object){share.activity.init();share.activity.initShareMenuForActivity(share_object);share.initChatterModal();
};share.addShareObject=function(obj){this.shareObjects["share|"+obj.uniqueId]=obj;};share.getShareObject=function(target){return this.shareObjects[target];};share.chatterModal=null;share.activityModal=null;share.initShareMenus=function(param){var len=param.length;var newObj;for(var i=0;i<len;i++){newObj=new shareObject(param[i]);
this.addShareObject(newObj);}if(this.chatter.chatterModal===null){this.chatter.init();}if(this.activity.activityModal===null){this.activity.init();}if(this.container===null){this.init();}};share.calculateMashupCoords=function(D,menu){var targetHt=D.offsetHeight;var targetTop=D.offsetTop;var targetLeft=D.offsetLeft;
var C=D.offsetParent;var cont=$("#"+this.hook)[0];while(C){targetTop+=C.offsetTop||0;targetLeft+=C.offsetLeft||0;C=C.offsetParent;}var contHt=cont.scrollHeight;var contTop=cont.offsetTop;var contLeft=cont.offsetLeft;C=cont.offsetParent;while(C){contTop+=C.offsetTop||0;contLeft+=C.offsetLeft||0;C=C.offsetParent;
}var contPos=this.getTargetPosition(cont);var contScrollTop=cont.scrollTop;var vTop=cont.scrollTop;var vBottom=cont.scrollTop+contPos.height;var targBottom=targetTop+targetHt;var htAboveTarg=targetTop-cont.scrollTop;var htBelow=vBottom-targBottom;var menuTop=0;var menuLeft=targetLeft;if(htAboveTarg>menu.height){menuTop=targetTop-menu.height-contScrollTop;
}else{menuTop=targBottom-contScrollTop;}return[menuTop+"px",menuLeft+"px"];};share.hoverPos=function(D,menu){var B=D.offsetHeight;var F=D.offsetTop;var A=D.offsetLeft;var C=D.offsetParent;while(C){F+=C.offsetTop||0;A+=C.offsetLeft||0;C=C.offsetParent;}var I=this.scrollXY();var G=this.windowXY();if(F-I[1]+menu.height>G[1]){F=F-(B+menu.height);
}if(A-I[0]+menu.width>G[0]){A=G[0]+I[0]-menu.width;}var H=F+B;var E=A;return[H+"px",E+"px"];};share.windowXY=function(){var A=0;var B=0;if(typeof window.innerWidth=="number"){A=window.innerWidth;B=window.innerHeight;}else{if(document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)){A=document.documentElement.clientWidth;
B=document.documentElement.clientHeight;}else{if(document.body&&(document.body.clientWidth||document.body.clientHeight)){A=document.body.clientWidth;B=document.body.clientHeight;}}}return[A,B];};share.scrollXY=function(){var A=0;var B=0;if(typeof window.pageYOffset=="number"){A=window.pageXOffset;B=window.pageYOffset;
}else{if(document.body&&(document.body.scrollLeft||document.body.scrollTop)){A=document.body.scrollLeft;B=document.body.scrollTop;}else{if(document.documentElement&&(document.documentElement.scrollLeft||document.documentElement.scrollTop)){A=document.documentElement.scrollLeft;B=document.documentElement.scrollTop;
}}}return[A,B];};share.hideShareMenu=function(){if(share.isDisplayed){share.container.style.display="none";share.isDisplayed=false;}};share.launchShareMenu=function(targetId){if(this.isDisplayed){this.hideShareMenu();}var item=this.getShareObject(targetId);item.show(this.container);this.container.style.display="block";
this.positionMenu(targetId);this.isDisplayed=true;};share.positionMenu=function(target){var menuPos=this.getTargetPosition(this.container);var coords;var elem=document.getElementById(target);if(this.inMashup){coords=share.calculateMashupCoords(elem,menuPos);}else{coords=this.hoverPos(elem,menuPos);}this.container.style.left=coords[1];
this.container.style.top=coords[0];};share.getTargetPosition=function(node){var rect=node.getBoundingClientRect();return{"top":parseInt(rect.top),"left":parseInt(rect.left),"right":parseInt(rect.right),"bottom":parseInt(rect.bottom),"height":parseInt(rect.bottom-rect.top),"width":parseInt(rect.right-rect.left)};
};registerNS("share.chatter");share.chatter={chatterModal:null,init:function(){this.chatterModal=new modal();this.chatterModal.initModalDialog({metrics:{width:600},content:iv.ui.getTemplate("chatterShare"),callback:$.proxy(this.hookChatter,this),mashup:iv.isMashup});},hookChatter:function(){var $this=this;
$("#chatter-modal-form").submit(function(event){$this.postChatter();event.stopPropagation();return false;});},showChatter:function(articleUrl,newsTitle,crmAccountId,crmObjectId,crmOpportunityId,crmContext){this.chatterModal.displayModal();$("#chatter_link_url").val(decodeURIComponent(articleUrl));$("#chatter_link_name").val(newsTitle);
$("#chatter_crmAccountId").val(crmAccountId);$("#chatter_crmObjectId").val(crmObjectId);$("#chatter_crmOpportunityId").val(crmOpportunityId);$("#chatter_crmContext").val(crmContext);$("#chatter-modal-form .secondary_button").unbind("click").bind("click",$.proxy(this.hideChatter,this));iv.util.logUserActivity("share-menu-chatter");
},hideChatter:function(){this.chatterModal.hideModal();},postChatter:function(){var $this=this;var formObj=$("#chatter-modal-form")[0];$("#chatter-share-button").attr("disabled","true");formObj.exportType.value="chatter";$("#loadingChatterResult").css("display","inline");iv.api.submitForm({form:$("#chatter-modal-form"),success:function(data){$this.showChatterResult(data);
return false;}});return false;},showChatterResult:function(xhr){var $this=this;var data=xhr.responseText.split("|");if(data[0]==="true"){$("#chatterResultSuccess").html(data[1]);setTimeout(function(){$this.chatterModal.hideModal();},1500);$("#loadingChatterResult").hide();}if(data[0]==="false"){$("#chatterResultError").html(data[1]);
$("#loadingChatterResult").hide();$("#chatter-share-button").removeAttr("disabled");}}};registerNS("share.activity");share.activity={activityModal:null,hasActivityLogin:false,curActivity:{},init:function(){this.activityModal=new modal();this.activityModal.initModalDialog({metrics:{width:550},content:iv.ui.getTemplate("activityShare"),callback:$.proxy(this.hookActivity,this),mashup:this.inMashup});
},hookActivity:function(){var $this=this;$("#activity-modal-form").submit(function(){$this.postActivity();return false;});var params=this.curActivity;if(typeof this.curActivity.articleUrl!="undefined"){$("#activity_link_url").val(params.articleUrl);$("#activity_link_name").val(params.newsTitle);$("#activity_crmAccountId").val(params.crmAccountId);
$("#activity_crmObjectId").val(params.crmObjectId);$("#activity_crmOpportunityId").val(params.crmOpportunityId);$("#activity_crmContext").val(params.crmContext);}},postActivity:function(){var $this=this;var formObj=$("#activity-modal-form")[0];$("#activity-share-button").attr("disabled","true");formObj.exportType.value="activity";
$("#loadingActivityResult").css("display","inline");$("#activityResultError , #activityResultSuccess").hide();iv.api.submitForm({form:$("#activity-modal-form"),success:function(data){$this.showActivityResult(data);return false;}});return false;},showActivityResult:function(resp){$("#loadingActivityResult").hide();
var resp=JSON.parse(resp.responseText);if(!resp.error){$("#activityResultSuccess .message").html(resp.data);$("#activityResultSuccess").show();setTimeout("share.activity.hideActivity();$('#activity-share-button').removeAttr('disabled');",2000);}if(resp.error){$("#activityResultError .message").html(resp.errorMessage);
$("#activityResultError").show();$("#activity-share-button").removeAttr("disabled");}},showActivity:function(articleUrl,newsTitle,crmAccountId,crmObjectId,crmOpportunityId,crmContext){this.curActivity={urls:{"articleUrl":decodeURIComponent(articleUrl)},"articleUrl":decodeURIComponent(articleUrl),"newsTitle":newsTitle,"crmAccountId":crmAccountId,"crmObjectId":crmObjectId,"crmOpportunityId":crmOpportunityId,"crmContext":crmContext};
this.activityModal.displayModal();$("#activity_link_url").val(decodeURIComponent(articleUrl));$("#activity_link_name").val(newsTitle);$("#activity_crmAccountId").val(crmAccountId);$("#activity_crmObjectId").val(crmObjectId);$("#activity_crmOpportunityId").val(crmOpportunityId);$("#activity_crmContext").val(crmContext);
$("#activity-modal-form .secondary_button").unbind("click").bind("click",$.proxy(this.hideChatter,this));iv.util.logUserActivity("share-menu-activity");},showActivityLogIn:function(ref){var html='<div style="text-align:center;height:258px;"><span style="display:inline-block;padding-top:111px;"><img style="float:left;" src="/iv/common/styles/images/LoadingAnimation.gif"/><span style="display: inline-block;font-size: 30px;font-weight: bold;padding-left: 15px;padding-top: 0px;">Loading...</span></span></div>';
this.activityLoginModal=new modal();this.activityLoginModal.initModalDialog({metrics:{width:390},content:html,callback:function(){},mashup:this.inMashup});this.activityLoginModal.displayModal();var $this=this;iv.api.getHtmlContent({target:$("#modal-content"),resource:"/iv/crm2011ApiLogin.iv",urlParams:{methodName:"showLogin"},success:function(resp){$this.showSuccessActivityLogIn(ref,resp);
},error:$this.showErrorActivityLogIn});},showSuccessActivityLogIn:function(ref,resp){if(document.getElementById("showActivity")!=null){this.hasActivityLogin=true;this.activityLoginModal.hideModal();if((typeof ref.fromArticleLauncher!="undefined")&&ref.fromArticleLauncher){$("#sa"+ref.cuid).unbind();this.initShareMenuForActivity(ref);
}this.showActivity(ref.urls.articleUrl,ref.newsTitle,ref.crmAccountId,ref.crmObjectId,ref.crmOpportunityId,ref.crmContext);}else{if($("#dynamics_org_2011").css("display")=="block"){$("span.label").addClass("bigger-label");}else{if($("#dynamics_url_2011").css("display")=="block"){$("span.label").addClass("big-label");
}}this.attachActivityLogInEvents(ref);}},showErrorActivityLogIn:function(resp){this.activityLoginModal.contentDiv.innerHTML="Ajax Call Failed";},attachActivityLogInEvents:function(ref){var $this=this;$("input[type=button].form_cancel_button").bind("click",function(){$this.activityLoginModal.hideModal();
});$("input.input_field").focus(function(){$(this).css("border-color","");$(this).parent().children(".error_ticker").remove();});$("input[type=button].form_login_button").bind("click",function(){$(".yellowbox").hide();var canSubmit=true;var errorMessage="Please enter a valid ";$.each($("input.input_field"),function(){if($.trim(this.value)==""){$(this).css("border-color","#990000");
errorMessage=errorMessage+$(this).attr("alt");errorMessage=errorMessage+", ";if($(this).next().length==0){$(this).after('<span class="common_sprites error_ticker" style="float: none;display: inline-block;"></span>');}canSubmit=false;}});if(!canSubmit){errorMessage=errorMessage.substr(0,errorMessage.length-2);
errorMessage=errorMessage+".";$(".yellowbox .errorMessage").html(errorMessage);$(".yellowbox").show();return false;}$(".button-cover").show();iv.api.submitForm({form:$('form[name="dynamicsLoginForm"]'),success:function(resp){$this.successActivityLogin(ref,resp);},error:$this.errorActivityLogin});});},successActivityLogin:function(ref,resp){var $this=this;
var resp=JSON.parse(resp.responseText);if(!resp.error){$this.hasActivityLogin=true;$this.activityLoginModal.hideModal();if((typeof ref.fromArticleLauncher!="undefined")&&ref.fromArticleLauncher){$("#sa"+ref.cuid).unbind();$this.initShareMenuForActivity(ref);}$this.showActivity(ref.urls.articleUrl,ref.newsTitle,ref.crmAccountId,ref.crmObjectId,ref.crmOpportunityId,ref.crmContext);
}else{if(resp.error){$(".yellowbox .errorMessage").html(resp.errorMessage);$(".yellowbox").show();$(".button-cover").hide();}}},errorActivityLogin:function(resp){var resp=JSON.parse(resp.responseText);$(".yellowbox .errorMessage").html(resp.errorMessage);$(".yellowbox").show();$(".button-cover").hide();
},hideActivity:function(){this.activityModal.hideModal();},initShareMenuForActivity:function(share_object){var ref=share_object;var $this=this;if(ref.showActivity&&this.hasActivityLogin){$("#sa"+ref.cuid).bind("click",function(event){$this.showActivity(ref.urls.articleUrl,ref.newsTitle,ref.crmAccountId,ref.crmObjectId,ref.crmOpportunityId,ref.crmContext);
if(typeof share.hideShareMenu!="undefined"){share.hideShareMenu();}event.stopPropagation();return false;});}else{$("#sa"+ref.cuid).bind("click",function(event){$this.showActivityLogIn(share_object);if(typeof share.hideShareMenu!="undefined"){share.hideShareMenu();}event.stopPropagation();return false;
});}}};var company={tabs:{"overview":"tabAnalysis","people":"tabPeople","buzz":"tabBuzz","familyTree":"tabFamilyTree","market":"tabCompetitors"},init:function(type,data){this[type].init(data);if(typeof type!=="undefined"){if(typeof this.tabs[type]!=="undefined"){var targTab=$("#"+this.tabs[type]);if(targTab.hasClass("secondaryNavListItems")){targTab.removeClass("secondaryNavListItems").addClass("secondaryNavListItemSelected");
}}}this.initCommonTooltips();if(typeof companyMetaData!=="undefined"){this.genericTasks(companyMetaData);}},genericTasks:function(data){this.initFollowButton(data);},initFollowButton:function(data){var followButtonConfig={followType:"button",entityType:"company",companyId:data.companyId,trackedByWatchlists:data.trackedByWatchlists,watchlistInfo:iv.user.data.genericWatchlistInfo};
iv.follow.manager.createWidgets([{"selector":"#follow-"+followButtonConfig.companyId,"config":followButtonConfig}]);},setSubMenuState:function(targetId){var t=$("#"+targetId);var tStateText=$(t.children()[0]).html();t.hide();t.css({"border-right":"0px solid"});var tmenu=t.parents(".secondaryNavMore");
if(tmenu.hasClass("secondaryNavListItems")){tmenu.removeClass("secondaryNavListItems");}if(tmenu.hasClass("secondaryNavMore")){tmenu.removeClass("secondaryNavMore").addClass("secondaryNavMoreSelected");}var tmenuId=$(tmenu[0]).attr("id");var stateHook=$("#"+tmenuId+"_stateHook");var stateCont=stateHook.find(".secondaryNavSubMenuState");
stateCont.html(tStateText);stateHook.show();tmenu.show();},initCommonTooltips:function(){var moreTickersLink=$("#moreTickersLink");var holder=$("#all_tickers");if(moreTickersLink.length>0&&holder.length>0){var content=holder.html();holder.remove();new ivTooltip({"target":"moreTickersLink","delay":100,"timeOut":100,"width":180,"displayCallback":function(){},"prefetch":false,"content":content});
}},trackIt:function(id,url){iv.api.userAction.getHtmlContent({resource:url,target:$("#add_"+id),postLoad:function(){iv.initMenus();}});}};if(!company){var company={};}if(!company.overview){company.overview={data:null,showSourceth:null,sprytooltipsource:null,init:function(data){this.data=data;company.userFlag.init($("#flag-content"),data);
for(var i=1;i<location.href.split("&").length;i++){if(location.href.split("&")[i]==="showWrongInfo=true"){company.userFlag.initAndTrigger(data);}}document.getElementById("export").style.display="block";$("#exportContainer").css({"width":"180px"});this.initTooltips();if(typeof data.company_active!="undefined"&&data.company_active==="false"){this.initInactiveModal(data);
this.outOfBizPopUp.displayModal();return false;}var smad=data.smartAgentsData;smad.companyId=data.companyId;smad.companyName=data.companyName;smad.isMashup=iv.isMashup;company.overview.newAgents.init(data.smartAgentsData);company.overview.connections.init(data.connectionsData);data.connectionsData.connectionWidgetContainer="overviewTab-conn-widget";
company.connections.init(data.connectionsData);this.expandBucket(data.expand);},initInactiveModal:function(data){this.outOfBizPopUp=new modal();this.outOfBizPopUp.initModalDialog({metrics:{width:470},content:_.template(iv.ui.getTemplate("company.inactiveModal"),{row:data}),controlsEnabled:true,moveControlEnabled:false,callback:function(){if(data.status=="Out of Business "){$(".header_line_dashed").css("display","none");
$("#cName").css("display","none");$("#companyInactive").css("margin-left","60px");}}});},initTooltips:function(){var industryProfileLink=$("#industryProfileLink");if(industryProfileLink.length>0){var holder=$("#all_industry");var content=holder.html();holder.remove();new ivTooltip({"target":"industryProfileLink","delay":100,"timeOut":100,"width":550,"displayCallback":function(){},"prefetch":false,"content":content});
}var financialDetailsLink=$("#financialDetailsLink");if(financialDetailsLink.length>0){var holder=$("#all_revenue");var content=holder.html();holder.remove();new ivTooltip({"target":"financialDetailsLink","delay":100,"timeOut":100,"width":265,"displayCallback":function(){},"prefetch":false,"content":content});
}var moreWebsitesLink=$("#moreWebsitesLink");if(moreWebsitesLink.length>0){var holder=$("#all_websites");var content=holder.html();holder.remove();new ivTooltip({"target":"moreWebsitesLink","delay":100,"timeOut":100,"width":200,"displayCallback":function(){},"prefetch":false,"content":content});}this.initSourceTooltips();
},sourceTooltipMap:{},initSourceTooltips:function(){var ref=this;$(".sourcehover").each(function(){ref.sourceTooltipMap[this.id]=new ivTooltip({"target":this.id,"delay":100,"timeOut":100,"width":180,"enforcePosition":"bottom","displayCallback":function(){},"prefetch":false,"dataSource":this.href});});
$(".sourcehover").click(function(){return false;});},expandBucket:function(type){if(type==="linkedin"){this.expandLinkedin();}else{if(type==="smartconnection"){this.expandSmartConnection();}}},expandLinkedin:function(){company.overview.connections.expandLinkedin();},expandSmartConnection:function(){company.overview.connections.expandSmartConnection();
},openWebsitePopup:function(companyURL,track){if(companyURL.substring(0,4)!=="http"){var tCompanyURL="http://"+companyURL;companyURL=tCompanyURL;}var extWindow=window.open(companyURL);if(typeof track==="boolean"){if(track){iv.util.logUserActivity("/company-url");}}extWindow.focus();},getSpryAgents:function(divid,url){if(document.getElementById("IMG_"+divid).src.indexOf("_1.gif")===-1){logThisClick("company_detail_standalone","agents_expand_link");
var hp=new Spry.Widget.HTMLPanel("div_"+divid,{evalScripts:true});hp.addObserver({onPreLoad:function(){Spry.$("span_"+divid).style.display="block";}});hp.addObserver({onPostUpdate:function(){Spry.$("div_"+divid).style.display="block";Spry.$("span_"+divid).style.display="none";}});hp.loadContent(url);
Spry.$("IMG_"+divid).style.marginTop="5px";}else{logThisClick("company_detail_standalone","agents_collapse_link");Spry.$("span_"+divid).style.display="none";Spry.$("div_"+divid).style.display="none";Spry.$("IMG_"+divid).style.marginTop="2px";}}};}iv.processOnDomReady(function(){company.init("overview",companyOverViewData);
});registerNS("company.overview.newAgents");company.overview.newAgents={urls:{smartAgentsUrl:"/iv/loadSmartAgents.do",fetchArticlesUrl:"/iv/companyinfo.do",logActivity:"/iv/logActivity.do"},spryTooltipAgents:null,prefetchCount:0,agentList:[],agentResultMap:{},articlesMap:{},shareDataMap:{},templates:{smartAgentList:"<~%if(agents.length > 0){%~>"+'	<div class="tabs">'+'	<ul class="smart-agent-list">'+"	<~% var index=0; _.each(agents, function(agent) { %~>"+"	<~%if(index > 0){%~>"+'		<li name="<~%=agent.category%~>-<~%=agent.agentId%~>-<~%=agent.agentName%~>" class="item" title="<~%=agent.agentName%~>"><~%=agent.smallAgentName%~></li>'+"	<~%} else {%~>"+'		<li name="<~%=agent.category%~>-<~%=agent.agentId%~>-<~%=agent.agentName%~>" class="active-item" title="<~%=agent.agentName%~>"><~%=agent.smallAgentName%~></li>'+"	<~%} index++;});%~>"+"	</ul>"+'	<a id="modifyAgents" class="bluefont_11px" '+'	<~%if(isMashup){%~> target="insideview" <~%}%~>'+'	href="/iv/manageSellingTriggers.do?methodName=showSellingTriggers">Modify Agents</a>'+"	</div>"+"<~%}%~>",emptyAgentList:'<div class="no-agents-message">There are no agent results for the last <~%=searchDays%~> days. '+"<~% if(searchDays == 1) { %~>"+'Try searching the last <a class="bluefont" href="javascript:void(0)" onclick="company.overview.newAgents.searchForSevenDays();return false;">7</a> days.'+"<~% } %~>"+"</div>"+'<div class="no-agents-link">View:&nbsp;&nbsp;'+"<~% if(!isMashup) { %~>"+'<a class="bluefont" href="/iv/companyinfo.do?methodToCall=news&id=<~%=companyId%~>">News</a>'+"<~% } else { %~>"+'<a class="bluefont" onclick="company.forceClickAndLoad(\'tabNews\');return false;" href="javascript:void(0);">News</a>'+"<~% } %~>"+'<span class="pipe">|</span>&nbsp;'+"<~% if(!isMashup) {%~>"+'<a class="bluefont" href="/iv/buzz.iv?id=<~%=companyId%~>">Buzz</a>'+"<~% } else {%~>"+'<a class="bluefont" onclick="company.forceClickAndLoad(\'tabBuzz\');return false;" href="javascript:void(0);">Buzz</a>'+"<~% } %~>"+"</div>",articles:"<~% var encCompName = encodeURIComponent(companyName); _.each(agents, function(agent) { "+"%~>"+'	<div class="buckets">'+"	<~% if (agents.length > 1) { %~>"+'		<div class="group-title"><~%=agent.resultCount%~> <~%=agent.agentName%~></div><div style="clear:both;"></div>'+"	<~%}%~>"+"	<~% _.each(agent.results, function(article) {"+'article.caJoin=""; if(article.commonArticles.length>0){'+'article.caJoin=article.commonArticles.join(",");}'+"		if (article.sourceCount == 0) {"+"			article.shortSource = article.source.substring(0, isMashup? 40 : 10);"+"		}"+"		else {"+"			article.shortSource = article.source.substring(0, isMashup? 23 : 8);"+"		}"+"		if (article.source.length > article.shortSource.length) {"+"			article.shortDate = article.dateText.substring(0, article.dateText.lastIndexOf(' ')) + \"...\";"+"			article.shortSource += '...';"+"		} else {article.shortDate = article.dateText;}"+"		if (isMashup) {"+"			article.shortNewsText = article.newsText.substring(0, 114);"+"		}"+"		else {"+"			article.shortNewsText = article.newsText.substring(0, 74);"+"		}"+"		if (article.newsText.length > article.shortNewsText.length) {"+"			article.shortNewsText += '...';"+"		}"+"	article.articleTitleEncoded = encodeURIComponent(article.newsText);"+""+"				%~>"+'		<div class="article">'+'		<div class="article-title">'+'			<a 	id="<~%=article.articleId%~>|<~%=companyId%~>" '+'				class="article article_tooltip"'+'				target="_blank" href="/iv/launchArticle.do?mode=SellingTrigger&article_id=<~%=article.articleId%~>&company_id=<~%=companyId%~>&selling_trigger=<~%=agent.agentName%~>&from=<~%=from%~>&company_name=<~%=encCompName%~>">'+"			<~%=article.shortNewsText%~>"+"			</a>"+"		</div>"+'		<div class="article-citation">'+'			<label title="<~%=article.source%~>"><~%=article.shortSource%~>'+'			<~% if (article.sourceAccessStatus == 1) {%~> <img class="citation-img" src="/iv/common/styles/images/padlock.png" alt="May require a registration" title="May require a registration" /> <~% } %~>'+'			<~% if (article.sourceAccessStatus == 2) {%~> <img class="citation-img" src="/iv/common/styles/images/dollar.png" alt="May require a registration" title="May require a registration" /> <~% } %~>'+"			</label>"+'			<label title="<~%=article.dateText%~>">&nbsp;-&nbsp; <~%=article.shortDate%~> &nbsp;|&nbsp;</label>'+"			<~%if(article.sourceCount > 0){%~>"+'			<a onclick="return hs.htmlExpand(this, { objectType:\'ajax\', preserveContent: true} );" href="/iv/launchArticleGroup.do?groupId=<~%=article.groupId%~>&companyId=<~%=companyId%~>&articleIds=<~%=article.caJoin%~>&agentId=<~%=agent.agentId%~>&leadArticleId=<~%=article.articleId%~>&methodName=getArticleGroup&selling_trigger=<~%=agent.agentName%~>&from=<~%=from%~>" target="_blank" class="highslide bluefont_11px">'+"			<~%=article.sourceCount%~> more</a>"+"			<label>&nbsp;|&nbsp;</label>"+"			<~%}%~>"+'			<div class="share-link" style="float:left;" id="share|<~%=article.articleId%~>|<~%=companyId%~>|<~%=agent.agentId%~>">'+'	        <span class="article-link">'+'					<div class="share">Share</div>'+'					<div class="down-arrow"></div>'+"			</span>"+"			</div>"+"		</div>"+'		<div style="clear:both;"></div>'+"		</div>"+"	<~%});%~>"+"	</div>"+"<~%});%~>"},data:null,init:function(data){this.resetMaps();
this.data=data;this.fetchSmartAgentList();this.setUpEventHandlers();},resetMaps:function(){this.prefetchCount=0;this.agentList=[];this.agentResultMap={};this.articlesMap={};this.shareDataMap={};this.peopleUpdates={};},setUpEventHandlers:function(){$("#activityDays").bind("click",function(){$(".activityDaysCount").hide();
$("#activityDaysOption").css("display","inline");});$("#activityDaysOption").bind("change",function(){var $this=company.overview.newAgents;$this.resetMaps();var selectedValue=$(this).val();$this.fetchSmartAgentList(selectedValue);$(this).blur();iv.util.logUserActivity("agent-duration-val-"+selectedValue);
});$("#activityDaysOption li").bind("click",function(){var $this=company.overview.newAgents;$this.resetMaps();var selectedValue=$(this).attr("id");$this.fetchSmartAgentList(selectedValue);$(this).blur();iv.util.logUserActivity("agent-duration-val-"+selectedValue);});},tabSwitchEventHandler:function(){var elem=$(this);
$(".active-item").bind("click",company.overview.newAgents.tabSwitchEventHandler);$(".active-item").removeClass("active-item").addClass("item");elem.removeClass("item").addClass("active-item").unbind("click");$(".articles").css("border-left","0");$(".articles").html('<img class="loader" style="vertical-align:middle;" src="/iv/common/styles/images/indicator.gif"/>'+'<span class="loader" style="color:#999999;"> Loading articles..</span>');
var $this=company.overview.newAgents;var agentInfo=elem.attr("name");$this.fetchArticles(agentInfo,true);},fetchSmartAgentList:function(days){$(".smart-agent-warning").hide();if($(".smart-agent-tabs").length==0){$(".smart-agent-content").html('<div class="smart-agent-tabs"></div><div class="articles"></div>');
}$(".articles").empty();$(".smart-agent-tabs").html('<img style="vertical-align:middle;" src="/iv/common/styles/images/indicator.gif"/>'+'<span style="color:#999999;"> Loading Agents..</span>');var params={id:this.data.companyId,methodToCall:"loadSmartAgentList",fromMashup:this.data.isMashup,now:(new Date()).getTime()};
if(typeof days!="undefined"){params.searchDays=days;}iv.api.getJson({resource:this.urls.smartAgentsUrl,urlParams:params,success:company.overview.newAgents.smartAgentListCallback,error:function(resp){if(typeof resp!="undefined"&&typeof resp.error!="undefined"&&resp.error){alert(resp.errorMessage);}}});
},shareConfig:{showChatter:false,showSaveAs:false,showDynamicsActivityFeed:false},createPeopleUpdatesSection:function(data,companyId,companyName,isNewsPresent){iv.util.require([iv.ui.getTemplate("commonRequires.peopleUpdates")],function(){iv.peopleUpdates.showPeopleUpdatesSection(data,companyId,companyName,isNewsPresent,".smart-agent-content .articles");
});},smartAgentListCallback:function(resp){var $this=company.overview.newAgents;if(resp.error){alert(resp.errorMessage);}else{var results=resp.data;$this.agentList=results.agentResultSets;if($this.data.showPeopleUpdates&&results.peopleUpdates&&results.peopleUpdates.length>0){$this.peopleUpdates=results.peopleUpdates;
}$this.shareConfig.showChatter=results.showChatter;$this.shareConfig.showDynamicsActivityFeed=results.showDynamicsActivityFeed;$this.shareConfig.showSaveAs=results.showSaveAs;$("#activityDaysOption").val(results.searchDays).hide();var searchDays="";if(results.searchDays=="1"){searchDays=results.searchDays+"&nbsp;Day&nbsp;";
}else{searchDays=results.searchDays+"&nbsp;Days&nbsp;";}$("#activityDays").html(searchDays).show();$("#daysMenu").show();var isAgentsRestricted=results.totalAgents>results.agentResultSets.length;if(isAgentsRestricted){$("#freeAgents").html(results.agentResultSets.length);$("#totalAgents").html(results.totalAgents);
$(".smart-agent-warning").fadeIn("slow");}var agentResultSets=results.agentResultSets;if(agentResultSets.length==0){var infoMessage=_.template($this.templates.emptyAgentList,{searchDays:results.searchDays,companyId:$this.data.companyId,isMashup:$this.data.isMashup});$(".smart-agent-content").html(infoMessage);
}else{for(var index=0;index<agentResultSets.length;index++){var agent=agentResultSets[index];var agentCount=agent.resultCount;if(agent.agentId==1&&$this.peopleUpdates&&$this.peopleUpdates.length>0){agentCount=agentCount+$this.peopleUpdates.length;}var agentText=agentCount+" "+agent.agentName;agent.smallAgentName=agentText.substring(0,18);
if(agentText.length>agent.smallAgentName.length){agent.smallAgentName+="...";}agentResultSets[index]=agent;}var agentList=_.template($this.templates.smartAgentList,{agents:agentResultSets,isMashup:$this.data.isMashup});$(".smart-agent-tabs").html(agentList);$(".articles").css("border-left","0");$(".item").bind("click",$this.tabSwitchEventHandler);
if($.browser.msie&&parseInt($.browser.version,10)<7){$(".item").bind("mouseover",function(){$(".itemHover").removeClass("itemHover");$(this).addClass("itemHover");});$(".item").bind("mouseout",function(){$(".itemHover").removeClass("itemHover");});}var firstAgent=agentResultSets[0];var agentInfo=firstAgent.category+"-"+firstAgent.agentId+"-"+firstAgent.agentName;
$this.saveAgentArticles(agentInfo,firstAgent);$this.fetchArticles(agentInfo);}if(results.totalAgents>=1){iv.userExperiments.triggerExperiment("1");}}$(".agent-days").show();},fetchArticles:function(agentInfo,userAction){var logAction=false;if(typeof userAction==="boolean"){if(userAction){logAction=true;
}}var agents=this.agentResultMap[agentInfo];if(typeof agents=="undefined"||agents==null){if(logAction){var agentInfoArray=agentInfo.split("-");var params={id:this.data.companyId,from:this.data.isMashup?"mashup":"companyinfo",methodToCall:"loadArticlesInJSON",category:agentInfoArray[0],agentId:agentInfoArray[1],agentName:agentInfoArray[2],now:(new Date()).getTime()};
if(this.data.isMashup){params.crm_account_id=this.data.crm_account_id;params.crm_context=this.data.crm_context;params.crm_object_id=this.data.crm_object_id;params.crm_opportunity_id=this.data.crm_opportunity_id;params.crmdeployid=this.data.crmdeployid;}else{params.crmdeployid="";}iv.api.userAction.getJson({resource:this.urls.fetchArticlesUrl,urlParams:params,success:function(resp){company.overview.newAgents.fetchArticlesCallback(resp,agentInfo);
company.overview.newAgents.displayArticles(agentInfo);},error:function(resp){if(typeof resp!="undefined"&&typeof resp.error!="undefined"&&resp.error){alert(resp.errorMessage);}}});}else{iv.api.getJson({resource:this.urls.fetchArticlesUrl,urlParams:params,success:function(resp){company.overview.newAgents.fetchArticlesCallback(resp,agentInfo);
company.overview.newAgents.displayArticles(agentInfo);},error:function(resp){if(typeof resp!="undefined"&&typeof resp.error!="undefined"&&resp.error){alert(resp.errorMessage);}}});}}else{this.displayArticles(agentInfo);if(logAction){this.logActivity(agentInfo);}}},saveAgentArticles:function(agentInfo,articles){this.agentResultMap[agentInfo]=articles;
},fetchArticlesCallback:function(resp,agentInfo){var $this=company.overview.newAgents;if(resp.error){alert(resp.errorMessage);}else{var results=resp.data;$this.saveAgentArticles(agentInfo,results);$this.prefetchCount++;}},logActivity:function(agentInfo){iv.util.logUserActivity("company-agent",{"agent":agentInfo});
},displayArticles:function(agentInfo){var $this=company.overview.newAgents;var agentSet=[];var shareDataSet=[];var agentResult=$this.agentResultMap[agentInfo];if(typeof agentResult!="undefined"||agentResult!=null){agentSet[agentSet.length]=$this.agentResultMap[agentInfo];}var td={agents:[agentResult],isMashup:$this.data.isMashup,companyId:$this.data.companyId,companyName:$this.data.companyName,crmdeployid:$this.data.crmdeployid,from:$this.data.isMashup?"mashup":"companyinfo"};
var html=_.template($this.templates.articles,td);$(".articles").html(html);if(agentResult.agentId=="1"&&$this.peopleUpdates&&$this.peopleUpdates.length>0){var isNewsPresent=true;if(agentResult.resultCount==0){isNewsPresent=false;}$this.createPeopleUpdatesSection($this.peopleUpdates,$this.data.companyId,$this.data.companyName,isNewsPresent);
}window.setTimeout(function(){var $this=company.overview.newAgents;$(".articles .loader").remove();for(var i=0;i<agentSet.length;i++){var agent=agentSet[i];for(var j=0;j<agent.results.length;j++){var article=agent.results[j];$this.articlePreview(article.articleId,agent.agentName);}}var tabHeight=$(".smart-agent-tabs").height();
var articlesHeight=$(".articles").height();if(tabHeight>articlesHeight){$(".articles").css("border-left","0");}else{$(".smart-agent-tabs").css("border-right","0");$(".articles").css("border-left","0");}shareDataSet=agentResult.results;for(var index=0;index<shareDataSet.length;index++){var obj={"newsId":shareDataSet[index].articleId,"companyId":$this.data.companyId,"companyName":$this.data.companyName,"newsTitle":shareDataSet[index].newsText,"agentName":agentResult.agentName,"agentId":agentResult.agentId,"showChatter":$this.shareConfig.showChatter,"showSaveAs":$this.shareConfig.showSaveAs,"showDynamicsActivityFeed":$this.shareConfig.showDynamicsActivityFeed};
if($this.data.isMashup){obj.crmAccountId=$this.data.crm_account_id;obj.crmContext=$this.data.crm_context;obj.crmObjectId=$this.data.crm_object_id;obj.crmOpportunityId=$this.data.crm_opportunity_id;}share.initShareMenus([obj]);}if($this.data.isMashup){$("#content_panel").scrollTop(0);}else{$(window).scrollTop(0);
}},100);},searchForSevenDays:function(){$("#activityDaysOption").val("7");$("#activityDaysOption").change();},articlePreviewTracker:{},startTracking:function(id){if(this.articlePreviewTracker[id]===null){this.articlePreviewTracker[id]=(new Date()).getTime();}},stopTracking:function(id){if(this.articlePreviewTracker[id]===null){return;
}var startTime=this.articlePreviewTracker[id];var stopTime=new Date().getTime();if((stopTime-startTime)>300){iv.util.logUserActivity("ArticlePreview");}this.articlePreviewTracker[id]=null;},articlePreview:function(id,agentName){var url="/iv/callout?isHttp=yes&mode=SellingTrigger&id="+id+"&crmdeployid="+this.data.crmdeployid+"&selling_trigger_keywords="+agentName+"&company_id="+this.data.companyId;
var $this=this;var elems=$(".article").filter(function(){return $(this).attr("id")==id+"|"+$this.data.companyId;});elems.each(function(){new ivTooltip({"target":$(this)[0],"delay":400,"timeOut":200,"width":400,"displayCallback":function(){},"prefetch":false,"dataSource":url,"smallerFrame":$this.data.smallerFrame});
});},articleMouseOut:function(){company.overview.newAgents.stopTracking($(this).attr("id"));}};registerNS("company.overview.connections");company.overview.connections={urls:{connectionsUrl:"/iv/companyinfo.do",buzzUrl:"/iv/tweetsposts.iv",linkedInUrl:"/iv/fetchLinkedInData.do",twitterUrl:"/iv/twitterInfo.do"},images:{"loaderImg":"/iv/common/styles/images/SmallLoadingAnimation.gif"},data:null,linkedInCallInProgress:false,init:function(data){this.data=data;
var ref=this;_.each(this.data.companySignificant,function(str,key){ref.data.companySignificant[key]=str.toLowerCase();});this.getShortBuzz();},getShortBuzz:function(){if(this.data.buzzData.twitterHandle.length==0&&this.data.buzzData.fbHandle.length==0&&this.data.buzzData.blogHandle.length==0){return;
}var params={twitterScreenName:this.data.buzzData.twitterHandle,fbScreenName:this.data.buzzData.fbHandle,blogHandle:this.data.buzzData.blogHandle,facebookAccessToken:this.data.buzzData.facebookAccessToken};iv.api.getJson({resource:this.urls.buzzUrl,urlParams:params,success:$.proxy(company.overview.connections.getShortBuzzCallback,this),error:function(resp){if(typeof resp!="undefined"&&typeof resp.error!="undefined"&&resp.error){if(resp.errorType!=420){}}}});
},getShortBuzzCallback:function(resp){$this=this;if(resp.error){if(resp.errorType!=420){}return;}else{var data=resp.data.updates;if(data.length>0){var html=_.template(iv.ui.getTemplate("company.miniBuzz"),{data:data,companyId:this.data.companyId});$(".postsContainer").html(html);$("#shortBuzz").fadeIn("slow");
$this.hookShortbuzz();}}},hookShortbuzz:function(){var $this=this.data;iv.facebook.hooks.init($this.buzzData);iv.twitter.hooks.init($this.buzzData);iv.twitter.hooks.setLoggerImageUrl($this.buzzData.twitterLoggerImageURL);},setUpHelpHover:function(){var smallerFrameTooltip=true;if(!this.data.isMashup){smallerFrameTooltip=false;
}if(this.data.isMashup){if(this.data.isLargerMashup){smallerFrameTooltip=false;}}var html='<div class="help-txt"> <div class="logo"></div>'+"<ul>"+'<li class="titleTxt">What are Smart Connections?</li>'+'<li class="description">Add your previous employers and reference customers to discover relationships you can use to engage with prospects.</li>'+"</ul>"+" </div>";
var tt=new ivTooltip({"target":$("#whatsThis")[0],"delay":400,"timeOut":200,"width":212,"displayCallback":function(){iv.analytics.trackEvent("/companyInfo/smartConnection","whatIsThis","smart connection help");},content:html});},initFacebookApplication:function(){window.fbAsyncInit=this.FBLoadTask;var e=document.createElement("script");
e.type="text/javascript";e.src=document.location.protocol+"//connect.facebook.net/en_GB/all.js";e.async=true;document.getElementById("fb-root").appendChild(e);},FBLoadTask:function(){var $this=company.overview.connections;FB.init({appId:$this.data.fbAppId,status:true,cookie:true,xfbml:true,channelUrl:window.location.protocol+"//"+window.location.host+"/iv/common/includes/channel.html"});
FB.Event.subscribe("auth.statusChange",function(response){if(response.session){$this.FBSessionSuccess();}else{$this.FBSessionFail();}});FB.getLoginStatus(function(response){if(response.session){$this.FBSessionSuccess();}else{$this.FBSessionFail();}});$("#facebookLogin").bind("click",function(){FB.login(function(response){if(response.session){if(response.perms){$this.FBSessionSuccess();
}else{$this.FBSessionFail();}}else{$this.FBSessionFail();}},{perms:"user_work_history,friends_work_history,friends_location,friends_photos,user_location"});});},resetFBFlags:function(){this.workersReady=false;this.renderConnections=false;this.connectionsRendered=false;},overRideForFriends:function(){this.sessionSuccessHideShowPlay();
this.processFBFriends(company.dataStorage.fetch("FBFriendData"));},sessionSuccessHideShowPlay:function(){$("#fb-show-connections").show();$("#facebookLogin").hide();$("#fb-msg").hide();},FBSessionSuccess:function(){this.sessionSuccessHideShowPlay();this.getUserFriends();},FBSessionFail:function(){$("#fb-show-connections").hide();
$("#facebookLogin").show();$("#fb-msg").show();$("#fb-connections-details").html('<img src="/iv/common/styles/images/indicator.gif" width="12" height="12" border="0">&nbsp;Loading connections from Facebook...');},saveUserFBData:function(response){this.data.userFBData=response;},getUserFriends:function(){var query="SELECT uid, name,current_location, pic_small,pic_square, work_history, profile_url FROM user WHERE uid IN (SELECT uid2 FROM friend WHERE uid1 = me())";
FB.api({method:"fql.query",query:query},function(response){company.overview.connections.processFBFriends(response);});},workers:[],workersReady:false,processFBFriends:function(response){this.friends=response;this.workers=[];var friends=response;var len=friends.length;if(typeof company.dataStorage!=="undefined"){company.dataStorage.save("FBFriendData",this.friends);
}_.each(friends,this.findWorker,this);this.workersReady=true;if(typeof company.dataStorage!=="undefined"){company.dataStorage.save("FBWorkerData",this.workers);}if(this.renderConnections){this.renderFBConnections();}},renderConnections:false,connectionsRendered:false,toggleFBBox:function(){doToggleObjDisplay("fb-connections-details");
if(!this.workersReady){this.renderConnections=true;}else{this.renderFBConnections();}var expCol="";if($("#fb-connections-details").css("display")==="block"){expCol="EXPAND";}else{expCol="COLLAPSE";}iv.util.logUserActivity("Facebook-Conn-"+expCol);},findWorker:function(friend){var relevant_work=[];var foundAJob=false;
if(!_.isUndefined(friend.work_history)&&!_.isNull(friend.work_history)){if(friend.work_history.length>0){_.each(friend.work_history,function(work){if(!_.isUndefined(work.company_name)&&!_.isNull(work.company_name)){_.each(this.data.companySignificant,function(cs){if(work.company_name.toLowerCase().indexOf(cs)!==-1&&cs!==""&&!foundAJob){foundAJob=true;
relevant_work[relevant_work.length]=work;}},this);}},this);}}if(relevant_work.length>0){friend.relevant_work=relevant_work;friend=this.isPastEmployment(friend);this.workers[this.workers.length]=friend;}},isPastEmployment:function(friend){var curDate=new Date();var month=curDate.getMonth()+1;var year=curDate.getFullYear();
var tempWork=null;_.each(friend.relevant_work,function(work){var endDateSplit=work.end_date.split("-");var endMonth=parseInt(endDateSplit[1]);var endYear=parseInt(endDateSplit[0]);if((work.start_date===""||work.start_date==="0000-00")&&(work.end_date===""||work.end_date==="0000-00")){work.isPast=false;
tempWork=work;}else{if(work.start_date!==""&&work.start_date!=="0000-00"&&(work.end_date===""||work.end_date==="0000-00")){work.isPast=false;tempWork=work;}else{if(work.start_date!==""&&work.start_date!=="0000-00"&&work.end_date!==""&&work.end_date!=="0000-00"){if(endYear<year){work.isPast=true;tempWork=work;
}else{if(endYear===year){if(endMonth<month){work.isPast=true;tempWork=work;}else{work.isPast=false;tempWork=work;}}else{work.isPast=false;tempWork=work;}}}else{work.isPast=false;tempWork=work;}}}});friend.relevant_work=tempWork;return friend;},sortWorkers:function(){this.workers.sort(function(a,b){var a=a.name.toUpperCase();
var b=b.name.toUpperCase();if(a<b){return -1;}if(a>b){return 1;}return 0;});},renderFBConnections:function(){if(this.connectionsRendered){return false;}var connContent="No Facebook Connections Found.";if(this.workers.length>0){this.sortWorkers();connContent=_.template(iv.ui.getTemplate("company.overview.connections.fbTemplate"),{workers:this.workers});
}$("#fb-connections-details").html(connContent);this.connectionsRendered=true;}};registerNS("company.connections");company.connections={data:null,connectionSetup:true,container:null,shownData:false,init:function(data){this.data=data;this.container=this.data.connectionWidgetContainer;if(company.connections.data.workflow==="person"){$("#contactLink").bind("click",function(){$(".connection-graphs, .connectionData").hide();
$(".emp-details-divider").show();});$(".connections-container").delegate(".referralLink","click",function(){iv.util.logUserActivity("Ask-for-Referral");});}this.fetchedLinkedInData=false;if(company.connections.data.workflow==="company"){company.connections.connectionHelpHover("linkedIn");$(".linkedInLogin").bind("click",function(){iv.util.doOpenExtWindow("/iv/authorizeOnLinkedIn.do?methodName=authorize&from=linkedin_connections",800,600);
});}$(".linkedInConnHeader .expandable, .linkedInConnHeader .linkedInLogo14px, .linkedInConnHeader a").click(function(){if($(".linkedInConnectionLink #linkedInConnContainer").filter(":visible").length>0){$(".linkedInConnectionLink #linkedInConnContainer").filter(":visible").slideUp();$(".linkedInConnHeader .collapsible").removeClass("expandable").removeClass("collapsible").addClass("expandable");
}else{company.connections.getLinkedInConnections();$(".linkedInConnHeader .expandable").removeClass("expandable").removeClass("collapsible").addClass("collapsible");}});this.getConnections();},getConnections:function(){if(company.connections.data.workflow==="company"){iv.api.getJson({resource:"/iv/companyConnectionsSummary.do",urlParams:{methodName:"getConnectionSummary",companyId:this.data.companyId},success:company.connections.getConnectionsCallback,error:company.connections.getConnectionsErrorCallback});
}else{iv.api.getJson({resource:"/iv/executiveConnectionsSummary.do",urlParams:{methodName:"getExecConnectionSummary",companyId:this.data.companyId,employmentId:this.data.employmentId},success:company.connections.getConnectionsCallback,error:company.connections.getConnectionsErrorCallback});}},hasDirectConnections:function(dto){return dto.isCurrentCompany||dto.isPreviousCompany||dto.isReferenceCompany||dto.isTeamReferenceCompany;
},getConnectionsCallback:function(resp){if(!resp.data.connectionSetup){company.connections.connectionHelpHover("connection");}$(".connectionContainer").show();$(".column2 .wrapper").show();if(typeof resp.data.showReferral!="undefined"&&resp.data.showReferral){$(".noConnection").show();var el=$("#"+company.connections.container).find(".connectionContainer.outerWidgetBox");
el.find(".innerWidgetBox, .widgetBoxHeader, #newLinkedInLink").hide();el.css("padding",0);$(".connectionsBox").hide();$(".moreConnections").hide();}else{if(resp.data.connectionSetup){if(resp.data.totalConnections===0&&company.connections.data.workflow==="company"){if(typeof resp.data.directConnectionDTO!="undefined"&&company.connections.hasDirectConnections(resp.data.directConnectionDTO)){var html=_.template(iv.ui.getTemplate("company.connections.directConnections"),resp.data.directConnectionDTO);
$("#"+company.connections.container+" .connectionResult").before(html);$(".connectionsBox > DIV, .connectionsBox > hr").hide();$(".connectionsBox DIV.directConnections").show().css("border-bottom","1px");}else{$(".totalCount").html(resp.data.totalConnections+"&nbsp;people");$(".viewAll").hide();}$(".moreConnections").hide();
}else{if(company.connections.data.workflow==="company"){if(resp.data.totalConnections===1){$(".totalCount").html(resp.data.totalConnections+"&nbsp;person");}else{$(".totalCount").html(resp.data.totalConnections+"&nbsp;people");}if(typeof resp.data.directConnectionDTO!="undefined"&&company.connections.hasDirectConnections(resp.data.directConnectionDTO)){var html=_.template(iv.ui.getTemplate("company.connections.directConnections"),resp.data.directConnectionDTO);
$("#"+company.connections.container+" .connectionResult").before(html);}var url1=$("#view-all-1").attr("href");var allCurrent=false;for(var i=0;i<resp.data.connectionDataSet.length;i++){if(typeof(resp.data.connectionDataSet[i].activeInTarget)!=="undefined"){if(resp.data.connectionDataSet[i].activeInTarget){allCurrent=true;
break;}}}url1=url1+"&end="+resp.data.totalConnections;if(!allCurrent){url1=url1.replace("getAllCurrentEmploymentConnections","getAllPreviousEmploymentConnections");$("#view-all-1").attr("href",url1);}}else{if(resp.data.totalConnections===0){$(".white.connectionContainer").css("display","block");$(".grey.connectionContainer").css("display","none");
$(".column2 .wrapper").removeClass("grey");$(".column2 .wrapper").show();}else{$(".white.connectionContainer").remove();$(".grey.connectionContainer").css("display","block");$(".column2 .wrapper").removeClass("grey").addClass("grey");$(".column2 .wrapper").show();}if(resp.data.totalConnections===1&&resp.data.userConnection.length>0&&resp.data.userConnection[0].connType=="PERSONAL"){$("#viewAllSection").remove();
$(".moreConnections").hide();}if(resp.data.totalConnections===1){$(".totalCount").html(resp.data.totalConnections+"&nbsp;connection");}else{$(".totalCount").html(resp.data.totalConnections+"&nbsp;connections");}}if(company.connections.data.workflow==="company"){var html=_.template(iv.ui.getTemplate("company.connections.connectionResults"),{connectionResultSet:resp.data.connectionDataSet,companyId:company.connections.data.companyId,companyName:company.connections.data.companyName,companyNameStr:company.connections.data.companyName.replace("&#039;","\\&#039;"),isMashup:company.connections.data.isMashup,tab:company.connections.data.tab});
$("#"+company.connections.container+" .connectionResult").html(html);}else{company.connections.data.totalConnections=resp.data.totalConnections;var html=_.template(iv.ui.getTemplate("person.connections.connectionResults"),{connectionResultSet:resp.data.connectionDataSet,companyId:company.connections.data.companyId,userConnectionResultSet:resp.data.userConnection,fullName:company.connections.data.fullName,isMashup:company.connections.data.isMashup,firstName:company.connections.data.firstName,lastName:company.connections.data.lastName,tab:company.connections.data.tab});
$("#"+company.connections.container+" .connectionResult").html(html);var result=$(".content_connections .connectionResult");var innerWidget=result.parents(".innerWidgetBox");var knowPersonal=result.find(".personal");innerWidget.after(knowPersonal);if(result.find(".connectionDivider:visible, .connectionRow:visible").length==0){innerWidget.hide();
}knowPersonal.show();if(company.connections.data.totalConnections==0){$(".grey.connectionContainer").css("display","none");$(".white.connectionContainer").css("display","block");$(".wrapper").show();$(".column2 .wrapper").removeClass("grey").addClass("grey");$(".column2 .wrapper").show();}if($(".connectionDivider:first").siblings().length==0){$(".connectionDivider").css("border","none").css("padding","0px");
}else{$(".connectionRow:last").css("border","none");}}if(company.connections.data.workflow==="person"){$(".addPersonal").bind("click",company.connections.markAsPersonalConnection);}if(company.connections.data.workflow==="person"){$(".viewAll, .connectionsCount,.hoverClass").unbind("click").bind("click",company.connections.getContactExpandConnection);
}}}else{$(".connectionTag").show();$(".firstUse").show();$(".connectionsCount").hide();$(".connectionsBox").hide();$(".moreConnections").hide();$(".noConnection").hide();}}},markAsPersonalConnection:function(){$(".personal").html('<img src="/iv/common/styles/images/SmallLoadingAnimation.gif">');iv.api.getJson({resource:"/iv/personalConnections.do",urlParams:{methodToCall:"addPersonalConnection",executiveId:person.data.executiveId,employmentId:person.data.employmentId},success:company.connections.addPersonalConnectionCallback,error:company.connections.addPersonalConnectionErrorCallback});
},addPersonalConnectionCallback:function(resp){if(typeof resp!="undefined"&&typeof resp.error!="undefined"&&resp.error){$(".personal").html('<span style="font-size:11px;">'+resp.errorMessage+"</span>");}else{if($(".white.connectionContainer").length){$(".white.connectionContainer").remove();$(".grey.connectionContainer").css("display","block");
$(".column2 .wrapper").removeClass("grey").addClass("grey");$(".column2 .wrapper").show();}company.connections.data.totalConnections=(Number(company.connections.data.totalConnections)+1);$(".totalCount").html(company.connections.data.totalConnections+"&nbsp;connection");if(company.connections.data.totalConnections>1){$(".totalCount").append("s");
}$(".personalRow").show();$(".personal").remove();$(".grey.connectionContainer .innerWidgetBox").show();if(company.connections.data.totalConnections==1){$("#viewAllSection").remove();$(".moreConnections").hide();$(".connectionDivider").css("border","none").css("padding","0px");}}},addPersonalConnectionErrorCallback:function(resp){if(typeof resp!="undefined"&&typeof resp.error!="undefined"&&resp.error){$(".personal").html('<span style="font-size:11px;">'+resp.errorMessage+"</span>");
}},getConnectionsErrorCallback:function(){if(typeof resp!="undefined"&&typeof resp.error!="undefined"&&resp.error){$(".connectionContainer").hide();$(".column2 .wrapper").hide();}},getContactExpandConnection:function(){iv.util.logUserActivity("connection_clicked_on_executive_page");company.connections.showNewConnectionGraph();
},showNewConnectionGraph:function(){var graphId="connGraph_"+company.connections.data.employmentId;iv.util.require([iv.ui.getTemplate("commonRequires.modal")],function(){iv.modal.init({content:'<div id="'+graphId+'" class="connectionGraphContainer"><div class="crossButton"></div><div style="width: 780px;height: auto;text-align: center;margin: 50px 0;"><img src="/iv/common/styles/images/LoadingAnimation.gif"/></div></div>',hide:{event:"click",target:$(".close")},events:{render:function(event,api){company.connections.getNewConnectionGraphData($("#"+graphId));
var renderStartTime=new Date().getTime();$(this).data("renderStartTime",renderStartTime);iv.analytics.trackPageView("/iv/connections/modal");},hide:function(event){var $this=$(this);var renderStartTime=Number($(this).data("renderStartTime"));var hideTime=new Date().getTime();var diffInSeconds=(hideTime-renderStartTime)/1000;
if(diffInSeconds>=180){iv.analytics.trackPageView("/iv/connections/modal-exceeding-three-minutes");}else{if(diffInSeconds>=60){iv.analytics.trackPageView("/iv/connections/modal-exceeding-one-minute");}else{if(diffInSeconds>=10){iv.analytics.trackPageView("/iv/connections/modal-exceeding-ten-seconds");
}}}iv.modal.remove();}}});});return;},getNewConnectionGraphData:function(graphContainer){iv.api.getJson({resource:"/iv/getExecutiveConnectionGraph.iv",urlParams:{empId:company.connections.data.employmentId},success:function(resp){company.connections.handleNewConnectionGraphCallBack(resp,graphContainer);
},error:function(resp){company.connections.handleNewConnectionGraphCallBack(resp,graphContainer);}});},handleNewConnectionGraphCallBack:function(resp,graphContainer){if(!resp.error){connections.graph.renderer.init({data:resp.data.executiveEmploymentInfo,caller:this},graphContainer);}return resp;},getContactConnectionCallback:function(resp){company.connections.shownData=true;
$("#hide-contactData").hide();if(resp.data.executiveEmploymentInfo.connectionDetailsInfos.length>0){$("#connectionName").html(resp.data.executiveEmploymentInfo.name);resp.data.executiveEmploymentInfo.container=$(".connection-container");resp.data.executiveEmploymentInfo.cb=function(){};resp.data.executiveEmploymentInfo.isContact=true;
resp.data.executiveEmploymentInfo.isMashup=company.connections.data.isMashup;resp.data.executiveEmploymentInfo.fullName=company.connections.data.fullName;graph=new connections.graph(resp.data.executiveEmploymentInfo);graph.render();}},getContactConnectionErrorCallback:function(){$(".emp-details-divider").show();
$(".connection-graphs, .connectionData").hide();$("#hide-contactData").hide();if(typeof resp!="undefined"&&typeof resp.error!="undefined"&&resp.error){alert(resp.error);}},fetchedLinkedInData:false,getLinkedInConnections:function(){var linkedinConnections=$(".linkedInConnHeader:visible").next();if(this.fetchedLinkedInData){linkedinConnections.slideDown();
return;}var shortCompanyName=company.connections.data.companyName;if(shortCompanyName.length>12){shortCompanyName=shortCompanyName.substring(0,11)+"...";}var params={methodName:"getCompanyConnectionsInJSON",current:true,companyName:company.connections.data.companyName,companyShortName:shortCompanyName,companyId:company.connections.data.companyId,now:(new Date()).getTime()};
linkedinConnections.slideDown();var $this=this;linkedinConnections.slideDown(function(){iv.api.getJson({resource:"/iv/fetchLinkedInData.do",urlParams:params,success:function(resp){$this.getLinkedInConnectionsCallback(resp);},error:function(resp){if(typeof resp!="undefined"&&typeof resp.error!="undefined"&&resp.error){if(resp.errorType==401){var html='<div class="linkedInMessage" style="border:none;"><div class="linkedInIcon"></div><span>There was an error while contacting LinkedIn.</span></div>';
$("#linkedInConnContainer").html(html).slideDown();}else{if(resp.errorType==403){var html='<div class="linkedInMessage" style="border:none;"><div class="linkedInIcon"></div><span>You have exceeded your daily limit to view LinkedIn connections.</span></div>';$("#linkedInConnContainer").html(html).slideDown();
}else{if(console){if(console.error){console.error(resp.errorMessage);}}}}}}});});},getLinkedInConnectionsCallback:function(resp){if(resp.error){if(console){if(console.error){console.error(resp.errorMessage);}}return;}else{var data=resp.data;var results=data.details;if(!this.showAllLinkedin){results=data.details.splice(0,2);
}var shortCompanyName=company.connections.data.companyName;if(shortCompanyName.length>12){shortCompanyName=shortCompanyName.substring(0,11)+"...";}var html=_.template(iv.ui.getTemplate("connections.linkedInSummaryRow"),{data:results,totalCount:data.totalCount,companyName:company.connections.data.companyName,companyShortName:shortCompanyName,companyId:company.connections.data.companyId,isMashup:company.connections.data.isMashup});
$(".linkedInConnHeader:visible").next().html(html);company.connections.fetchedLinkedInData=true;}},connectionHelpHover:function(type){var smallerFrameTooltip=true;if(!this.data.isMashup){smallerFrameTooltip=false;}if(this.data.isMashup){if(this.data.isLargerMashup){smallerFrameTooltip=false;}}if(type==="connection"){target=$("#"+this.container+" .helpLogo")[0];
var html="<div>"+"Enter your previous employers and personal reference customers to see who you connect to at this company and how. </div>";}else{target=$("#"+this.container+" .helpLogo")[1];var html="<div>"+"Log in to LinkedIn and see who you connect to at this company through your LinkedIn connections. </div>";
}var tt=new ivTooltip({"target":target,"delay":400,"timeOut":200,"width":212,"displayCallback":function(){},content:html});}};if(!company){var company={};}company.userFlag={popUp:null,data:null,successPopUp:null,type:"dataFlag",defaultText:{"industry-suggest-note":"Correct Industry, if known","annualRev-note":"Current Annual "+iv.ui.getTemplate("localizedLabels.revenue")+", in "+iv.ui.getTemplate("localizedLabels.currency")+" (e.g.:5000000)","empCount-note":"Current Employee Count, if known","address-note":"Current Address, if known","companyUrl-note":"Current Company URL, if known","invalidOther-note":"Describe..."},setupModalBoxes:function(){var $this=this;
if(this.popUp===null){this.popUp=new modal();this.popUp.initModalDialog({metrics:{width:470},content:_.template(iv.ui.getTemplate("company.userFlag"),{companyId:this.data.company_id,industryName:this.data.industryName}),controlsEnabled:true,callback:function(){if($this.industryList===null){$this.fetchIndustryData();
}else{$this.attachEvents();}},disableOverlay:true});}if(this.successPopUp===null){this.successPopUp=new modal();this.successPopUp.initModalDialog({metrics:{width:400},content:_.template(iv.ui.getTemplate("company.userFlagSuccessMsg"),{}),controlsEnabled:true,callback:company.userFlag.userFlagSuccessCallBack,disableOverlay:true});
}},showPopupLoader:function(){$("#compflagoverlay").show();},hidePopupLoader:function(){$("#compflagoverlay").hide();},setupIndustryAutoComplete:function(){iv.util.setupNestedAutoComplete({id:"industry-suggest-note",data:this.industryList,template:"autocompleteIndustry"});},industryList:null,industryLoaded:function(industryList){this.industryList=industryList;
this.attachEvents();this.hidePopupLoader();},fetchIndustryData:function(){if(this.industryList===null){this.showPopupLoader();iv.api.getJSONP({resource:"/iv/common/includes/industryData.jsp?jsonp=company.userFlag.industryLoaded"});}},targetSelector:null,initComplete:false,initAndTrigger:function(data){this.initProcess(data);
this.showPopup();},initProcess:function(data){this.data=data;this.setupModalBoxes();this.initComplete=true;},init:function(target,data){if(this.initComplete){return;}this.initProcess(data);var ref=this;target.click(function(){ref.showPopup();});this.initComplete=true;},userFlagCallBack:function(){var blockSubmit=false;
$(".yellowbox").hide();var msg="";if(company.userFlag.type==="dataFlag"){var len=$("input:checkbox:checked").length;if(len!=0){for(var i=0;i<len;i++){var inp=$("input:checkbox:checked")[i].id+"-note";if($("#"+inp).val()===company.userFlag.defaultText[inp]){$("#"+inp).val("");}if(($("input:checkbox:checked")[i].id=="industry-suggest")&&($("#"+inp).val()==="")){blockSubmit=true;
msg="Please select any industry";}}if(!blockSubmit){if($("#send-flag").css("opacity")>0.5&&!$("#send-flag").hasClass("disabled")){iv.api.userAction.submitForm({form:$("#dataForm"),success:company.userFlag.userFlagSuccess});}$("#send-flag").css("opacity",".5");}else{$(".yellowbox").show();$("#errMsg").html(msg);
}}else{$(".yellowbox").show();$("#errMsg").html("Please select something");}}else{if($("#send-flag").css("opacity")>0.5){iv.api.userAction.submitForm({form:$("#recordForm"),success:company.userFlag.userFlagSuccess});}$("#send-flag").css("opacity",".5");}},cancelUserData:function(){company.userFlag.hidePopup();
},userFlagSuccess:function(resp){var resp=JSON.parse(resp.responseText);if(!resp.error){company.userFlag.successPopUp.displayModal();}else{$("#send-flag").css("opacity","1");$(".yellowbox").show();$("#errMsg").html(resp.errorMessage);}},userFlagSuccessCallBack:function(){setTimeout("company.userFlag.successPopUp.hideModal()",1500);
},showPopup:function(){if(!iv.isMashup){if($.browser.safari){bodyelem=$("body");}else{bodyelem=$("html,body");}bodyelem.scrollTop(100);}company.userFlag.type="dataFlag";this.popUp.displayModal();},hidePopup:function(){this.popUp.hideModal();},toggleContainers:function(){if(this.id==="remove-record-control"){$("#record-flag-cont,#back-to-report-data").show();
$("#data-flag,#remove-record-control").hide();company.userFlag.type="recordFlag";$(".yellowbox").hide();}else{$("#record-flag-cont,#back-to-report-data").hide();$("#data-flag,#remove-record-control").show();company.userFlag.type="dataFlag";}},eventAttached:false,attachEvents:function(){if(this.eventAttached){return;
}$("#remove-record-control,#back-to-report-data").live("click",company.userFlag.toggleContainers);$("#send-flag").live("click",company.userFlag.userFlagCallBack);$("#cancel-flag").live("click",company.userFlag.cancelUserData);$(".flag-row .check input").live("click",this.showTextBox);$(".flag-note .note").live("focus",this.removeDefaultText);
$(".flag-note .note").live("blur",this.showDefaultText);$(".flag-red-link").live("click",function(){$("#send-flag").removeClass("disabled");});$("#back-to-report-data").live("click",function(){if($(".flag-list input[type=checkbox]:checked").length>0){$("#send-flag").removeClass("disabled");}else{$("#send-flag").removeClass("disabled").addClass("disabled");
}});this.setupIndustryAutoComplete();},numberValidation:function(inp){var val=$(inp).val();val=val.replace(/[0-9]*/g,"");if(val!=""){$(inp).focus();return true;}},showTextBox:function(){if(this.checked){$("#"+this.id+"-note").show();$("#"+this.id+"-note").val(company.userFlag.defaultText[this.id+"-note"]);
$("#"+this.id+"-note").css({"color":"#666666","fontSize":"11px"});}else{$("#"+this.id+"-note").hide();}if($(".flag-list input[type=checkbox]:checked").length>0){$("#send-flag").removeClass("disabled");}else{$("#send-flag").removeClass("disabled").addClass("disabled");}},showDefaultText:function(){if($(this).val()===""){$(this).val(company.userFlag.defaultText[this.id]);
$(this).css({"color":"#666666","fontSize":"12px"});}},removeDefaultText:function(){if($(this).val()===company.userFlag.defaultText[this.id]){$(this).val("");$(this).css({"color":"#333333","fontSize":"12px"});}}};registerNS("iv.twitter.hooks");iv.twitter.hooks={url:"/iv/twitterInfo.do",images:{"retweetImg":"/iv/common/styles/images/retweet.png","loaderImg":"/iv/common/styles/images/SmallLoadingAnimation.gif","replyImg":"/iv/common/styles/images/replytweet.png"},config:{},data:{},checkTwitterAuthentication:function(){if(!this.data.twitterLoggedIn){var oAthUrl=this.url+"?call=authorize&from=buzz_tab";
iv.util.doOpenExtWindow(oAthUrl,800,600);return false;}return true;},retweet:function(obj){if(this.checkTwitterAuthentication()){this.doRetweet(this.getCurrObjectDetails(obj));}else{this.config={};this.config.retweetObj=this.getCurrObjectDetails(obj);}},doRetweet:function(obj){if(!obj){return;}var retweetImg=$(this.clickedObj).parent().find("img")[0];
retweetImg.src=this.images.loaderImg;iv.api.getJson({resource:this.url,urlParams:{call:"retweet",screenName:obj.userName,tweetId:obj.objectId},success:function(resp){iv.twitter.hooks.retweetCallback(resp);$(iv.twitter.hooks.clickedObj).replaceWith('<span class="greyText">Retweeted</span>');},error:this.retweetCallback});
},retweetCallback:function(resp){var retweetImg=$(iv.twitter.hooks.clickedObj).parent().find("img")[0];retweetImg.src=iv.twitter.hooks.images.retweetImg;if(!_.isUndefined(resp.errorType)&&resp.errorType=="INVALID_TOKEN"){iv.twitter.hooks.data.twitterLoggedIn=false;iv.twitter.hooks.checkTwitterAuthentication();
}else{if(typeof resp!="undefined"&&typeof resp.error!="undefined"&&!resp.error){iv.twitter.hooks.showConfirmationDialog("The tweet has been successfully retweeted.");}else{iv.twitter.hooks.showConfirmationDialog(resp.errorMessage);}}},reply:function(obj){if(this.checkTwitterAuthentication()){this.doReply(this.getCurrObjectDetails(obj));
}else{this.config={};this.config.replyObj=this.getCurrObjectDetails(obj);}},doReply:function(obj){if(!obj){return;}var html=_.template(iv.ui.getTemplate("contact.replyDialog"),{data:this.data,screenName:"@"+obj.userName,tweet:obj.postText,replyTweetId:obj.objectId});iv.util.require([iv.ui.getTemplate("commonRequires.modal")],function(){iv.modal.init({nestedModal:true,content:html+'<div class="crossButton"></div>',hide:{event:"click",target:$(".close")},events:{render:function(event,api){$(".reply-container textarea").unbind().bind("keyup change focus blur",function(event){var elem=$(this);
var length=elem.val().length;if(length==0){$("#tweetTextCount").removeClass("red").html(140-length);$("#replyTweetTrigger").addClass("disabled");}else{if(length>140){$("#tweetTextCount").removeClass("red").addClass("red").html(140-length);$("#replyTweetTrigger").removeClass("disabled").addClass("disabled");
}else{$("#tweetTextCount").removeClass("red").html(140-length);$("#replyTweetTrigger").removeClass("disabled");}}});$(".reply-container #replyTweetTrigger").unbind().bind("click",function(){if($(".reply-container textarea").val()==""){return;}var replyImg=$(iv.twitter.hooks.clickedObj).parent().find("img")[1];
replyImg.src=iv.twitter.hooks.images.loaderImg;var elem=$(this);iv.analytics.trackEvent("/buzzTab/twitter","replyTweet","Reply Tweet");iv.api.getJson({resource:iv.twitter.hooks.url,urlParams:{call:"replyTweet",screenName:iv.twitter.hooks.objectUserName,replyTweetId:iv.twitter.hooks.objectId,replyTweetText:$(".reply-container textarea").val()},success:function(){replyImg.src=iv.twitter.hooks.images.replyImg;
iv.modal.remove();iv.twitter.hooks.showConfirmationDialog("The reply has been sucessfully posted.");},error:function(resp){if(!_.isUndefined(resp.errorType)&&resp.errorType=="INVALID_TOKEN"){iv.twitter.hooks.data.twitterLoggedIn=false;iv.twitter.hooks.checkTwitterAuthentication();}else{replyImg.src=iv.twitter.hooks.images.replyImg;
iv.modal.remove();iv.twitter.hooks.showConfirmationDialog(resp.errorMessage);}}});});iv.util.setDefaultFocus($(".reply-container"));},hide:function(event){}}});});this.objectId=obj.objectId;this.objectUserName=obj.userName;},getCurrObjectDetails:function(obj){var objId=obj.attr("id").replace(/[^_]*_/,"");
var currentPost=$(obj).parents(".postText");var postText=currentPost.find(".text").html();var userName=currentPost.find(".userName").html().split("&nbsp;")[1];var imageUrl=currentPost.find(".imageUrl").html();var currentPostObject={"objectId":objId,"postText":postText,"userName":userName,"imageUrl":imageUrl?imageUrl:""};
this.data.imageUrl=imageUrl?imageUrl:"";this.clickedObj=obj;return currentPostObject;},showConfirmationDialog:function(msg){iv.util.require([iv.ui.getTemplate("commonRequires.modal")],function(){iv.modal.init({nestedModal:true,content:"<h2 style='margin:10px;'>"+msg+"</h2>"+'<div class="crossButton"></div>',hide:{event:"click",target:$(".close")},events:{render:function(event,api){window.setTimeout(function(){iv.modal.remove();
},2500);},hide:function(event){}}});});},setLoggerImageUrl:function(loggerImageUrl){this.data.loggerImageUrl=loggerImageUrl;},authenticationCallBack:function(){iv.hub.publishEvent("REFRESH_SETUP","addSocial");this.data.twitterLoggedIn=true;this.doRetweet(this.config.retweetObj);this.doReply(this.config.replyObj);
this.config={};},init:function(data){$.extend(this.data,data,true);$(".postsContainer").delegate(".retweet","click",function(){iv.twitter.hooks.retweet($(this));});$(".postsContainer").delegate(".reply","click",function(){iv.twitter.hooks.reply($(this));});}};registerNS("iv.facebook.hooks");iv.facebook.hooks={urls:{oAuth:"/iv/facebook.do?methodName=authorize&from=buzz_tab",like:"/iv/facebookInfo/like.iv",comment:"/iv/facebookInfo/comment.iv",share:""},images:{"likeImg":"/iv/common/styles/images/fblike.png","loaderImg":"/iv/common/styles/images/SmallLoadingAnimation.gif","commentImg":"/iv/common/styles/images/fbcomment.png"},config:{},data:{},checkFBAuthentication:function(){if(!this.data.facebookLoggedIn){iv.util.doOpenExtWindow(this.urls.oAuth,800,600);
return false;}return true;},like:function(obj){if(this.checkFBAuthentication()){this.doLike(this.getCurrObjectDetails(obj));}else{this.config={};this.config.likeObj=this.getCurrObjectDetails(obj);}},doLike:function(obj){if(!obj){return;}var likeImg=$(this.clickedObj).parent().find("img")[0];likeImg.src=this.images.loaderImg;
iv.api.getJson({resource:this.urls.like,urlParams:{post_id:obj.objectId},success:function(resp){iv.facebook.hooks.likeCallBack(resp);$(iv.facebook.hooks.clickedObj).replaceWith('<span class="greyText">Like</span>');},error:this.likeCallBack});},likeCallBack:function(resp){var likeImg=$(iv.facebook.hooks.clickedObj).parent().find("img")[0];
likeImg.src=iv.facebook.hooks.images.likeImg;if(typeof resp!="undefined"&&typeof resp.error!="undefined"&&!resp.error){iv.facebook.hooks.showConfirmationDialog("The post has been liked successfully!");}else{if(!_.isUndefined(resp.errorType)&&resp.errorType=="INVALID_TOKEN"){iv.facebook.hooks.data.facebookLoggedIn=false;
iv.facebook.hooks.like(iv.facebook.hooks.clickedObj);}else{if(!_.isUndefined(resp.errorType)&&resp.errorType=="FB_LIKED_ERROR"){$(iv.facebook.hooks.clickedObj).replaceWith('<span class="greyText">&nbsp;Like&nbsp;</span>');iv.facebook.hooks.showConfirmationDialog("The post has been already been liked.");
}else{iv.facebook.hooks.showConfirmationDialog(resp.errorMessage);}}}},comment:function(obj){if(this.checkFBAuthentication()){this.doComment(this.getCurrObjectDetails(obj));}else{this.config={};this.config.commentObj=this.getCurrObjectDetails(obj);}},doComment:function(obj){if(!obj){return;}var html=_.template(iv.ui.getTemplate("contact.fbReplyDialog"),{data:this.data,screenName:obj.userName,postText:obj.postText,replyCommentId:obj.objectId});
this.replyDialog=new modal();this.replyDialog.initModalDialog({metrics:{width:480},content:html,controlsEnabled:true,moveControlEnabled:false,callback:function(){if($(".reply-container textarea").val().length==0){$("#replyCommentTrigger").addClass("disabled");}$(".reply-container textarea").unbind().bind("keyup change focus blur",function(event){var elem=$(this);
var length=elem.val().length;if(length==0){$("#replyCommentTrigger").addClass("disabled");}else{$("#replyCommentTrigger").removeClass("disabled");}});$(".reply-container #replyCommentTrigger").unbind().bind("click",function(){if($(".reply-container textarea").val()==""){return;}var commentImg=$(iv.facebook.hooks.clickedObj).parent().find("img")[1];
commentImg.src=iv.facebook.hooks.images.loaderImg;var elem=$(this);iv.analytics.trackEvent("/buzzTab/facebook","replyPost","Comment Post");iv.api.getJson({resource:iv.facebook.hooks.urls.comment,urlParams:{post_id:iv.facebook.hooks.currObjectId,comment_message:$(".reply-container textarea").val()},success:function(){commentImg.src=iv.facebook.hooks.images.commentImg;
iv.facebook.hooks.replyDialog.hideModal();iv.facebook.hooks.showConfirmationDialog("The comment has been successfully posted!");},error:function(resp){commentImg.src=iv.facebook.hooks.images.commentImg;if(!_.isUndefined(resp.errorType)&&resp.errorType=="INVALID_TOKEN"){iv.facebook.hooks.data.facebookLoggedIn=false;
iv.facebook.hooks.checkFBAuthentication();}else{iv.facebook.hooks.replyDialog.hideModal();iv.facebook.hooks.showConfirmationDialog(resp.errorMessage);}}});});},mashup:iv.isMashup});this.replyDialog.displayModal();this.currObjectId=obj.objectId;},getCurrObjectDetails:function(obj){var objId=obj.attr("id").replace(/[^_]*_/,"");
var currentPost=$(obj).parents(".postText");var postText=currentPost.find(".text").html();var userName=currentPost.find(".userName").html().split("&nbsp;")[1];var imageUrl=currentPost.find(".imageUrl").html();var currentPostObject={"objectId":objId,"postText":postText,"userName":userName,"imageUrl":imageUrl?imageUrl:""};
this.data.imageUrl=imageUrl?imageUrl:"";this.clickedObj=obj;return currentPostObject;},setLoggerImageUrl:function(accessToken){this.data.loggerImageUrl="https://graph.facebook.com/me/picture?type=square&access_token="+accessToken;},authenticationCallBack:function(){iv.hub.publishEvent("REFRESH_SETUP","addSocial");
this.data.facebookLoggedIn=true;this.doLike(this.config.likeObj);this.doComment(this.config.commentObj);this.config={};},showConfirmationDialog:function(msg){var confirmDialog=new modal();confirmDialog.initModalDialog({metrics:{width:480},content:"<h2 style='margin:0;'>"+msg+"</h2>",controlsEnabled:false,moveControlEnabled:false,callback:function(){window.setTimeout(function(){confirmDialog.hideModal();
},2500);},mashup:iv.isMashup});confirmDialog.displayModal();},init:function(data){$.extend(this.data,data,true);$(".postsContainer").delegate(".fbLike","click",function(){iv.facebook.hooks.like($(this));});$(".postsContainer").delegate(".fbComment","click",function(){iv.facebook.hooks.comment($(this));
});if(typeof this.data.facebookAccessToken!="undefined"&&this.data.facebookAccessToken!=""){this.setLoggerImageUrl(this.data.facebookAccessToken);}}};